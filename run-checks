#!/bin/sh

mkdir -p bin
( cd bin &&  wget https://niemeyer.s3.amazonaws.com/spread-amd64.tar.gz -O spread.tar.gz && tar xzvf spread.tar.gz )
git clone https://github.com/snapcore/snapd target

export SPREAD_MODIFY_CORE_SNAP_FOR_REEXEC=0
export SPREAD_TRUST_TEST_KEYS=false
export SPREAD_SRU_VALIDATION=1
export SPREAD_SNAP_REEXEC=0
export SPREAD_CORE_CHANNEL=beta

. ./options
last_build_number=$(echo "$TRAVIS_COMMIT_MESSAGE" | perl -n -e '/'"$message"' \((.*?)\)/ && print $1' | cut -d+ -f1 | cut -d~ -f1)

cd target || exit 1
git checkout "$last_build_number"
sed 's/ubuntu-16.04-64/ubuntu-17.04-64/g' -i spread.yaml
../bin/spread -v linode:ubuntu-17.04-64:tests/main/
